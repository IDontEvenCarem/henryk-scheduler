<script setup lang="ts">
import {useQuasar ,QTree, QBtn, QCheckbox, QIcon, QCard, QScrollArea} from 'quasar'
import {dynamicQuery, database} from '@/dbintegration'
import { computed } from '@vue/reactivity';
import { type Todo, AddTodo, ToggleTodo, DeleteTodo} from '@/database';
import {ref} from 'vue'
import CreateTodoQModalVue from './Modals/CreateTodoQModal.vue';
import { EZModalYesNo } from '@/ezmodals';

const $q = useQuasar()
const todos = dynamicQuery(database.todos, [], table => table.toCollection())

const tree = computed(() => {
    // step one - prepare a mapping between parent id and children ids
    const idmap = new Map<number, number[]>()
    function insert_ids(own: number, parent: number | undefined = undefined) {
        if (parent !== undefined) {
            if (idmap.has(parent)) {
                idmap.get(parent)?.push(own)
            } else {
                idmap.set(parent, [own])
            }
        } else {
            idmap.set(own, []);
        }
    }
    todos.value.forEach(todo => {
        insert_ids(todo.id!, todo.parent_id)
    })
    
    // step two - build a tree based on that mapping
    function get_child_array (parent: number) : any {
        return idmap.get(parent)?.map(chid => todos.value.find(todo => todo.id === chid)).map(todo => ({...todo, children: get_child_array(todo!.id!)}))
    }
    const roots = todos.value.filter(todo => todo.parent_id === undefined).map(todo => ({...todo, children: get_child_array(todo.id!)}))
    return roots;
})

const checked = computed(() => {
    return todos.value.filter(todo => todo.done).map(todo => todo.id)
})

async function make_test_data () {
    const tltd = await AddTodo("Top-Level Todo")
    const subtd = await AddTodo("Sub Todo", tltd)
    const subsubtd = await AddTodo("Even Suber Todo", subtd)
}

function change_done (id: number, value: any) {
    ToggleTodo(id)
}

function add() {
    $q.dialog({
        component: CreateTodoQModalVue,
        componentProps: {}
    }).onOk(payload => {
        AddTodo(payload)
    })
}

function add_under(id: number) {
    $q.dialog({
        component: CreateTodoQModalVue,
        componentProps: {}
    }).onOk(payload => {
        AddTodo(payload, id)
    })
}

function edit(id: number) {

}

async function remove(id: number) {
    if (await EZModalYesNo("Are you sure?", "Do you want to delete this todo?")) {
        DeleteTodo(id)
    }
}

</script>

<template>
    <KeepAlive>
        <QCard bordered class="todos-wrap-card">
            <div class="whole-wrapper">
                <QScrollArea style="height: 100%;">
                    <QTree v-if="tree.length > 0" :nodes="tree" node-key="id" label-key="text" default-expand-all>
                        <template v-slot:default-header="prop">
                            <div class="todo-wrapper">
                                <QCheckbox color="positive" :name="prop.node.id.toString()" :val="prop.node.id" :model-value="checked" @update:model-value="v => change_done(prop.node.id, v)"></QCheckbox>
                                <div>{{prop.node.text}}</div>
                                <QIcon style="cursor: pointer;" name="add" @click.stop="e => add_under(prop.node.id)"/>
                                <QIcon style="cursor: pointer;" name="add_link" @click.stop="e => edit(prop.node.id)"/>
                                <QIcon style="cursor: pointer;" name="delete" @click.stop="e => remove(prop.node.id)"/>
                            </div>
                        </template>
                    </QTree>
                    <div v-else class="alternate-content">
                        <div>
                            <h5 style="text-align: center;">No todos yet</h5>
                        </div>
                    </div>
                </QScrollArea>
            </div>
            <QBtn color="primary" @click="add" style="margin: 10px;">Create todo</QBtn>
        </QCard>
    </KeepAlive>
</template>

<style scoped>

.todo-wrapper {
    display: grid;
    grid-template-columns: auto 1fr max-content max-content max-content max-content 25px;
    align-items: center;
    width: 100%;
}
.todo-wrapper > .q-icon {
    transition: opacity 200ms ease;
    opacity: 0;
}
.todo-wrapper:hover > .q-icon {
    opacity: 1;
}
.todos-wrap-card {
    height: 80vh; 
    box-shadow: 0px 0px 20px 10px #000000d5;
    display: grid;
    grid-template-rows: 1fr max-content;
}
</style>